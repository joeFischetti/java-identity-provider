<?xml version="1.0" encoding="UTF-8"?>
<!-- Licensed to the University Corporation for Advanced Internet
     Development, Inc. (UCAID) under one or more contributor license
     agreements.  See the NOTICE file distributed with this work for
     additional information regarding copyright ownership. The UCAID
     licenses this file to You under the Apache License, Version 2.0
     (the 'License'); you may not use this file except in compliance
     with the License.  You may obtain a copy of the License at
     
     http://www.apache.org/licenses/LICENSE-2.0
     
     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an 'AS IS' BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
     implied.  See the License for the specific language governing
     permissions and limitations under the License.  -->

<?define UpgradeUUID="8d3bfb53-47ff-4cbc-9363-cbf9e46bedc4"?>


<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="Shibboleth IdP" Language="1033" Version="3.0.0.0" Manufacturer="Shibboleth Consortium" UpgradeCode="$(var.UpgradeUUID)">
    <Package InstallerVersion="310" Compressed="yes" InstallScope="perMachine" Platform="$(var.msitype)" Description="Shibboleth IdP" Manufacturer="Shibboleth Consortium"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowSameVersionUpgrades="yes"
                  Schedule="afterInstallInitialize" />
    <MediaTemplate EmbedCab="yes"/>

    <Condition Message="Shibboleth requires a Windows NT-based operating system.">NOT Version9X</Condition>

   <!-- Information for the properties page of the msi -->

   <Property Id="ARPCONTACT" Value="contact@shibboleth.net" />
   <Property Id="ARPHELPLINK" Value="https://wiki.shibboleth.net/confluence/display/IDP30/Home" />
   <Property Id="ARPURLUPDATEINFO" Value="https://wiki.shibboleth.net/confluence/display/IDP30/Home" />
   <Property Id="ARPURLINFOABOUT" Value="http://shibboleth.net/" />

   <Feature Id="ProductFeature" Title="IdP" Level="1">
      <Feature Id="InstallJetty" Title="Jetty">
        <MergeRef Id="jetty"/>
      </Feature>
      <ComponentGroupRef Id="IdPGroup"/>
      <ComponentGroupRef Id="SaveRegistry"/>
      <ComponentRef Id="IdPPermissions"/>
   </Feature>

    <Directory Id="TARGETDIR" Name="SourceDir" >
      <Directory Id="ProgramFilesFolder" >
        <Directory Id="INSTALLDIR" Name="Shibboleth" >
          <Merge Id="jetty" Language="1033" SourceFile="$(var.ProjectDir)\jetty-$(var.msitype).msm" DiskId="1"/>
            <Directory Id="IdPFolder" Name="IdP">
              <Directory Id="CredsFolder" Name="creds"/>
              <Directory Id="ConfFolder" Name="conf"/>
              <Directory Id="JettyBaseFolder" Name="jetty-base">
                <Directory Id="StartDotD" Name="start.d"/>
              </Directory>
              <Component Id="IdPPermissions" Guid="{5672474B-3CD2-44EB-9942-871844A2B089}" Win64="no">
                <RegistryValue Id="SetPermissions" Root="HKLM" Key="SOFTWARE\Shibboleth\IdP" Name="SetPermissions" Value="TRUE" Type="string" KeyPath="yes" />
                <CreateFolder Directory="CredsFolder">
                  <Permission User="Administrators" GenericAll="yes"/>
                </CreateFolder>
                <CreateFolder Directory="ConfFolder">
                  <Permission User="Administrators" GenericAll="yes"/>
                </CreateFolder>
                <CreateFolder Directory="StartDotD">
                  <Permission User="Administrators" GenericAll="yes"/>
                </CreateFolder>
              </Component>
            </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Property Id="QI_INSTALLDIR" Secure="yes">
      <DirectorySearch Id="QiSearch" Depth="1" Path="C:\Program Files\Internet2\ShibIdP"/>
    </Property>

    <Property Id="QI_INSTALLDIR64" Secure="yes">
      <DirectorySearch Id="QiSearch" Depth="1" Path="C:\Program Files (x86)\Internet2\ShibIdP"/>
    </Property>

    <Property Id="JAVA_EXECUTABLE" Secure="yes">
        <DirectorySearch Id="JavaBinSearch" Depth="0" Path="[%JAVA_HOME]\bin">
            <FileSearch Id="JavaBinSearch" Name="java.exe"/>
        </DirectorySearch>
    </Property>

    <CustomAction Id="NoJavaBin" Error="Could not locate Java.exe please check the value for JAVA_HOME"/>

    <!-- Inherit the setup, if they were. -->
    <CustomAction Id="InheritInstallDir" Property="INSTALLDIR" Value="[OLD_INSTALLDIR]" />
    <CustomAction Id="InheritInstallJetty" Property="INSTALL_JETTY" Value="[OLD_INSTALL_JETTY]" />

    <!-- Other propetrties -->
    <CustomAction  Id="SetDNSName" Property="DNSNAME" Value="[ComputerName]"/>

    <Binary Id="WriteConfigFilesSrc" SourceFile="scripts\shib_write_configs.vbs" />
    <Binary Id="SetJavaIdpHomeSrc" SourceFile="scripts\shib_set_java_idp_home.vbs" />

    <CustomAction Id="WriteConfigFiles" BinaryKey="WriteConfigFilesSrc" VBScriptCall="" Execute="deferred" Impersonate="no"/>
    <CustomAction Id="SetJavaIdpHome" BinaryKey="SetJavaIdpHomeSrc" VBScriptCall="" Execute="immediate" />
    <CustomAction Id="SetWriteConfigFiles" Property="WriteConfigFiles" Value="[INSTALLDIR];@;[DNSNAME];@;[INSTALL_JETTY]" />


    <!-- Ant actions -->
    <CustomAction Id="SetIdpAnt" Property="QtIdpAnt" Value="&quot;[JAVA_EXECUTABLE]&quot; -cp &quot;[INSTALLDIR]\IdP\bin\lib\*;[INSTALLDIR]\IdP\war\WEB-INF\lib\*&quot; -Didp.home=&quot;[INSTALLDIR]\IdP&quot; org.apache.tools.ant.Main -e -f &quot;[INSTALLDIR]\IdP\bin\build.xml&quot; -Didp.property.file=idp.install.properties install-nocopy" />
    <CustomAction Id="RunIdpAnt" Directory="ProgramFilesFolder" ExeCommand="[QtIdpAnt]" Execute="deferred" Impersonate="no"/>
    <CustomAction Id="QtIdpAnt" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no"/>
      
    <CustomAction Id="SetJettyAnt" Property="QtJettyAnt" Value="&quot;[JAVA_EXECUTABLE]&quot; -cp &quot;[INSTALLDIR]\IdP\bin\lib\*;[INSTALLDIR]\IdP\war\WEB-INF\lib\*&quot; org.apache.tools.ant.Main -e -f &quot;[INSTALLDIR]\IdP\bin\ant-jetty.xml&quot; -Djetty.property.file=jetty.install.properties install"/>
    <CustomAction Id="RunJettyAnt" Directory="IdPFolder" ExeCommand="[QtJettyAnt]" Execute="deferred" Impersonate="no"/>
    <CustomAction Id="QtJettyAnt" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no"/>

    <InstallUISequence>

      <!-- inherit installationDir if there is something to inherit (Conditions set in ShibolethIdP-registry) -->
      <Custom Action="InheritInstallDir" After="AppSearch">
        OLD_INSTALLDIR
      </Custom>

      <!-- inherit JETTY_INSTALL if there is something to inherit AND JETTY_INSTALL was not passed in -->
      <Custom Action="InheritInstallJetty" After="AppSearch">
        OLD_INSTALL_JETTY AND NOT INSTALL_JETTY
      </Custom>
        
      <!-- Could we find JAVA.EXE ?-->
      <Custom Action="NoJavaBin" After="AppSearch">
        NOT JAVA_EXECUTABLE and NOT Installed
      </Custom>

      <Custom Action="SetDNSName" After="AppSearch">
        NOT DNSNAME
      </Custom>

    </InstallUISequence>

    <InstallExecuteSequence>

      <!-- Duplicate actions from the UI case -->
      <Custom Action="InheritInstallDir" After="AppSearch">
        OLD_INSTALLDIR
      </Custom>

      <!-- inherit JETTY_INSTALL if there is something to inherit AND JETTY_INSTALL was not passed in -->
      <Custom Action="InheritInstallJetty" After="AppSearch">
        OLD_JETTY_INSTALL AND NOT JETTY_INSTALL
      </Custom>

      <Custom Action="SetJavaIdpHome" Before="WriteRegistryValues"/>

      <!-- Could we find JAVA.EXE ?-->
      <Custom Action="NoJavaBin" After="AppSearch">
           NOT JAVA_EXECUTABLE
      </Custom>

      <!-- Work -->

      <Custom Action="SetWriteConfigFiles" Before="CostInitialize">NOT Installed</Custom>
      <Custom Action="WriteConfigFiles" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="SetIdpAnt" After="WriteConfigFiles">NOT Installed</Custom>
      <Custom Action="RunIdpAnt" After="SetIdpAnt">NOT Installed AND NOISY_INSTALL</Custom>
      <Custom Action="QtIdpAnt" After="SetIdpAnt">NOT Installed AND NOT NOISY_INSTALL</Custom>
      <Custom Action="SetJettyAnt" After="RunIdpAnt">NOT Installed AND INSTALL_JETTY</Custom>
      <Custom Action="RunJettyAnt" After="SetJettyAnt">NOT Installed AND INSTALL_JETTY AND NOISY_INSTALL</Custom>
      <Custom Action="QtJettyAnt" After="SetJettyAnt">NOT Installed AND INSTALL_JETTY AND NOT NOISY_INSTALL</Custom>

    </InstallExecuteSequence>

    <Upgrade Id="$(var.UpgradeUUID)">
      <UpgradeVersion ExcludeLanguages="yes" IncludeMaximum="yes" Maximum="127.255.255" Minimum="0.0.1" OnlyDetect="yes" Property="ALREADYINSTALLED"/>
    </Upgrade>

    <UIRef Id="ShibbolethInstallDir"/>
  </Product>
</Wix>
