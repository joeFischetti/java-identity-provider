<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
                           
       default-init-method="initialize"
       default-destroy-method="destroy">

    <!--
    This file provisions the IdP with information about the configured mechanisms used for managing
    subject identity information, including canonicalizing technology-specific subject names into principal
    names, and turning principal names back into technology-specific forms like SAML NameIDs.
    -->

    <!--
    These are lists of Subject Canonicalization flows that turn arbitrary Subject data into a string-based
    principal name that the rest of the IdP can operate on. They're used both after authentication and
    during operations like SAML attribute queries, to map the SAML Subject name into a principal name. 
    
    Flows are described with an ID that corresponds to a Spring Web Flow subflow name, and an optional
    activation function that tells the IdP whether the flow can be run or not on a particular Subject
    for a particular profile request. The default functions do simple checking for compatible syntax
    and data to operate on, to avoid wasted effort.
    -->

    <!-- Flows used after authentication to produce canonical principal name. -->
    <util:list id="shibboleth.PostLoginSubjectCanonicalizationFlows">
        <!--
        This is the standard post-login step that returns a username derived from the login process. If you
        have more complex needs such as mapping a certificate DN into a principal name, an alternative may
        be required.
        -->
        <bean id="SubjectC14NFlow/Simple" class="net.shibboleth.idp.authn.SubjectCanonicalizationFlowDescriptor">
            <property name="activationCondition">
                <bean class="net.shibboleth.idp.authn.impl.SimpleSubjectCanonicalization.ActivationCondition" />
            </property>
        </bean>
    </util:list>
    
    <!-- Flows used during SAML queries and related cases to reverse SAML NameIdentifier/NameIDs. -->

    <bean id="shibboleth.AbstractSAML1C14NFlowBean" abstract="true"
            class="net.shibboleth.idp.saml.nameid.NameIDCanonicalizationFlowDescriptor">
        <property name="activationCondition">
            <bean class="net.shibboleth.idp.saml.impl.nameid.NameIdentifierCanonicalization.ActivationCondition" />
        </property>
    </bean>

    <bean id="shibboleth.AbstractSAML2C14NFlowBean" abstract="true"
            class="net.shibboleth.idp.saml.nameid.NameIDCanonicalizationFlowDescriptor">
        <property name="activationCondition">
            <bean class="net.shibboleth.idp.saml.impl.nameid.NameIDCanonicalization.ActivationCondition" />
        </property>
    </bean>
    
    <util:list id="shibboleth.SAMLSubjectCanonicalizationFlows">
        
        <bean id="SubjectC14NFlow/SAML2/Transient" parent="shibboleth.AbstractSAML2C14NFlowBean"
            p:formats="#{ {'urn:oasis:names:tc:SAML:2.0:nameid-format:transient'} }" />
        
        <bean id="SubjectC14NFlow/SAML2/CryptoTransient" parent="shibboleth.AbstractSAML2C14NFlowBean"
            p:formats="#{ {'urn:oasis:names:tc:SAML:2.0:nameid-format:transient'} }" />
        
        <bean id="SubjectC14NFlow/SAML2/Direct" parent="shibboleth.AbstractSAML2C14NFlowBean"> 
            <property name="formats">
                <util:list>
                    <value>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</value>
                </util:list>
            </property>
        </bean>
               
        <bean id="SubjectC14NFlow/SAML1/Transient" parent="shibboleth.AbstractSAML1C14NFlowBean"
            p:formats="#{ {'urn:mace:shibboleth:1.0:nameIdentifier'} }" /> 

        <bean id="SubjectC14NFlow/SAML1/CryptoTransient" parent="shibboleth.AbstractSAML1C14NFlowBean" 
            p:formats="#{ {'urn:mace:shibboleth:1.0:nameIdentifier'} }" /> 

        <bean id="SubjectC14NFlow/SAML1/Direct" parent="shibboleth.AbstractSAML1C14NFlowBean"> 
            <property name="formats">
                <util:list>
                    <value>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</value>
                </util:list>
            </property>
        </bean>

        <!--
        This is installed to support the old mechanism of using PrincipalConnectors in the attribute
        resolver to map SAML Subjects back into principals. If you don't use those (or this is a new install)
        you can disable this.
        -->
        <bean id="SubjectC14NFlow/LegacyPrincipalConnector" class="net.shibboleth.idp.authn.SubjectCanonicalizationFlowDescriptor">
            <property name="activationCondition">
                <bean class="net.shibboleth.idp.saml.impl.nameid.LegacyCanonicalization.ActivationCondition" 
                    c:service-ref="shibboleth.AttributeResolverService"/>
            </property>
        </bean>

    </util:list>
    
</beans>
