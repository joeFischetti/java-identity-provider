##
## Velocity Template for attribute consent view-state
##
## Velocity context will contain the following properties :
##
## attributeConsentContext - context holding consentable attributes
## attributeConsentFlowDescriptor - attribute consent flow descriptor
## attributeDisplayNameFunction - function to display attribute name
## consentContext - context representing the state of a consent flow
## encoder - HTMLEncoder class
## flowExecutionKey - SWF execution key (this is built into the flowExecutionUrl)
## flowExecutionUrl - form action location
## flowRequestContext - Spring Web Flow RequestContext
## profileRequestContext - OpenSAML profile request context
## request - HttpServletRequest
## response - HttpServletResponse
## rpUIContext - context with SP UI information from the metadata
##
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/consent.css"/>
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/uapprove_jp.css"/>
        <title>#springMessage("idp.attributeConsent.title")</title>
    </head>
    <body>
        <form action="$flowExecutionUrl" method="post" style="padding:10px" >
            <div class="box">
                <header>
                    #set ($logo = $rpUIContext.getLogo())
                    #if ($logo)
                        <img src="$encoder.encodeForHTMLAttribute($logo)" alt="logo for $encoder.encodeForHTMLAttribute($rpUIContext.getServiceName())" class="organization_logo" />
                    #end
                    ## TODO federation logo
                </header>
                <p style="margin-top: 70px;">
                    #springMessage("idp.attributeConsent.serviceNameLabel")<br/>
                    <span class="service_name">$rpUIContext.serviceName</span>
                    #springMessage("idp.attributeConsent.of") <span class="organization_name">$encoder.encodeForHTML($rpUIContext.organizationName)</span>
                </p>
                <p style="margin-top: 10px;">
                    #springMessage("idp.attributeConsent.serviceDescriptionLabel")<br/>
                    <span class="service_description">$encoder.encodeForHTML($rpUIContext.serviceDescription)</span>
                    <br />
                </p>
                #set ($informationURL = $rpUIContext.informationURL)
                #if ($informationURL)
                    <p style="margin-top: 10px;">
                        <a href="$informationURL">#springMessage("idp.attributeConsent.informationURLLabel")</a>
                    </p>
                #end
                <div id="attributeRelease" >
                    <table>
                        <thead>
                            <tr>
                                <th colspan="3">
                                    #springMessage("idp.attributeConsent.attributesHeader")
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            #foreach($attribute in $attributeConsentContext.getConsentableAttributes().values())
                                #if ($foreach.count % 2 == 0)
                                    #set ($rowStyle = "background-color:#E4E5E3;")
                                #else
                                    #set ($rowStyle = "")
                                #end
                                <tr style=$rowStyle>
                                    <td>$attributeDisplayNameFunction.apply($attribute)</td>
                                    <td>
                                        #foreach($value in $attribute.values)
                                            <strong>$value.value</strong>
                                            <br />
                                            ## TODO replace $ with <br />
                                        #end
                                    </td>
                                    <td style="vertical-align: top">
                                        #if ($attributeConsentFlowDescriptor.perAttributeConsentEnabled)
                                            #set ($inputType = "checkbox")
                                        #else
                                            #set ($inputType = "hidden")
                                        #end
                                        <input type="$inputType" name="consentIds" value="$encoder.encodeForHTML($attribute.id)" checked />
                                    </td>
                                </tr>
                            #end
                        </tbody>
                    </table>
                </div>
                #set ($privacyStatementURL = $rpUIContext.privacyStatementURL)
                #if ($privacyStatementURL)
                    <p style="margin-top: 10px;">
                        <a href="$privacyStatementURL">#springMessage("idp.attributeConsent.privacyStatementURLLabel")</a>
                    </p>
                #end
                <div style="float:left;">
                    <p>
                        #springMessage("idp.attributeConsent.confirmationQuestion")
                    </p>
                    #if ($attributeConsentFlowDescriptor.doNotRememberConsentAllowed || $attributeConsentFlowDescriptor.globalConsentAllowed)
                        <div id="generalConsentDiv" style="display: block; background-color: #F6F6F6;border: 1px gray solid; padding: 10px; width: 92%;">
                        #springMessage("idp.attributeConsent.consentMethod")
                    #end
                    #if ($attributeConsentFlowDescriptor.doNotRememberConsentAllowed)
                        <p>
                            <input type="radio" name="_idp_consentOptions" value="_idp_doNotRememberConsent" />
                            #springMessage("idp.attributeConsent.doNotRememberConsent")
                            <ul>
                                #foreach( $i in ["1", "2", "3"] )
                                    #set($message = $springMacroRequestContext.getMessage("idp.attributeConsent.doNotRememberConsentItem$i"))
                                    #if("$message" != "")
                                        <li>$message</li>
                                    #end
                                #end 
                            </ul>
                        </p>
                    #end
                    #if ($attributeConsentFlowDescriptor.doNotRememberConsentAllowed || $attributeConsentFlowDescriptor.globalConsentAllowed)
                        <p>
                            <input type="radio" name="_idp_consentOptions" value="_idp_rememberConsent" checked />
                            #springMessage("idp.attributeConsent.rememberConsent")
                            <ul>
                                #foreach( $i in ["1", "2", "3"] )
                                    #set($message = $springMacroRequestContext.getMessage("idp.attributeConsent.rememberConsentItem$i"))
                                    #if("$message" != "")
                                        <li>$message</li>
                                    #end
                                #end   
                            </ul>
                        </p>
                    #end
                    #if ($attributeConsentFlowDescriptor.globalConsentAllowed)
                        <p>
                            <input type="radio" name="_idp_consentOptions" value="_idp_globalConsent" />
                            #springMessage("idp.attributeConsent.globalConsent")
                            <ul>
                            #foreach( $i in ["1", "2", "3"] )
                                #set($message = $springMacroRequestContext.getMessage("idp.attributeConsent.globalConsentItem$i"))
                                #if("$message" != "")
                                    <li>$message</li>
                                #end
                            #end
                            </ul> 
                        </p>
                    #end
                    #if ($attributeConsentFlowDescriptor.doNotRememberConsentAllowed || $attributeConsentFlowDescriptor.globalConsentAllowed)
                        #springMessage("idp.attributeConsent.consentMethodRevoke")
                        </div>
                    #end
                    <p style="text-align: center;">
                        ## TODO name of reset button ?
                        <input type="reset" name="_eventId_proceed" value="#springMessageText("idp.attributeConsent.reject" "Reject")" style="margin-right: 30px;" onclick="alert('#springMessage("idp.attributeConsent.rejectMessage")')" />
                        <input type="submit" name="_eventId_proceed" value="#springMessageText("idp.attributeConsent.accept" "Accept")" />
                    </p>
                </div>
            </div>
        </form>
    </body>
</html>
