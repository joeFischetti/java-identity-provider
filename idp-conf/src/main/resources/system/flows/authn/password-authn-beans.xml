<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
                           
       default-init-method="initialize"
       default-destroy-method="destroy">
       
    <import resource="../../../conf/authn/password-authn-config.xml" />

    <bean class="net.shibboleth.idp.profile.impl.ProfileActionBeanPostProcessor" />
    <bean class="net.shibboleth.ext.spring.config.IdentifiableBeanPostProcessor" />

    <bean id="ExtractUsernamePasswordFromBasicAuth"
        class="net.shibboleth.idp.authn.impl.ExtractUsernamePasswordFromBasicAuth" scope="prototype"
        p:httpServletRequest-ref="shibboleth.HttpServletRequest"
        p:lowercase-ref="shibboleth.authn.Password.Lowercase"
        p:uppercase-ref="shibboleth.authn.Password.Uppercase"
        p:trim-ref="shibboleth.authn.Password.Trim"
        p:transforms-ref="shibboleth.authn.Password.Transforms" />
    
    <bean id="ExtractUsernamePasswordFromFormRequest"
        class="net.shibboleth.idp.authn.impl.ExtractUsernamePasswordFromFormRequest" scope="prototype"
        p:httpServletRequest-ref="shibboleth.HttpServletRequest"
        p:usernameFieldName-ref="shibboleth.authn.Password.UsernameFieldName"
        p:passwordFieldName-ref="shibboleth.authn.Password.PasswordFieldName"
        p:SSOBypassFieldName-ref="shibboleth.authn.Password.SSOBypassFieldName"
        p:lowercase-ref="shibboleth.authn.Password.Lowercase"
        p:uppercase-ref="shibboleth.authn.Password.Uppercase"
        p:trim-ref="shibboleth.authn.Password.Trim"
        p:transforms-ref="shibboleth.authn.Password.Transforms" />
        
    <bean id="ValidateUsernamePasswordAgainstJAAS"
            class="net.shibboleth.idp.authn.impl.ValidateUsernamePasswordAgainstJAAS" scope="prototype"
            p:loginConfigNames-ref="shibboleth.authn.JAAS.LoginConfigNames" p:loginConfigType="JavaLoginConfig"
            p:classifiedMessages-ref="shibboleth.authn.Password.ClassifiedMessageMap"
            p:resultCachingPredicate="#{getObject('shibboleth.authn.Password.resultCachingPredicate')}">
        <property name="loginConfigParameters">
            <bean class="java.security.URIParameter">
                <constructor-arg ref="shibboleth.authn.JAAS.JAASConfigURI" />
            </bean>
        </property>
    </bean>

    <bean id="ValidateUsernamePasswordAgainstLDAP"
        class="net.shibboleth.idp.authn.impl.ValidateUsernamePasswordAgainstLDAP" scope="prototype"
        p:authenticator-ref="authenticator"
        p:classifiedMessages-ref="shibboleth.authn.Password.ClassifiedMessageMap"
        p:resultCachingPredicate="#{getObject('shibboleth.authn.Password.resultCachingPredicate')}"
        p:returnAttributes-ref="shibboleth.authn.LDAP.returnAttributes" />

    <bean name="authenticator" class="org.ldaptive.auth.Authenticator" lazy-init="true"
            p:resolveEntryOnFailure="true">
        <constructor-arg index="0">
            <bean class="org.ldaptive.auth.SearchDnResolver"
                p:baseDn-ref="shibboleth.authn.LDAP.baseDn"
                p:subtreeSearch-ref="shibboleth.authn.LDAP.subtreeSearch"
                p:userFilter-ref="shibboleth.authn.LDAP.userFilter"
                p:connectionFactory-ref="connectionFactory" />
        </constructor-arg>
        <constructor-arg index="1">
            <bean class="org.ldaptive.auth.BindAuthenticationHandler"
                p:connectionFactory-ref="connectionFactory" />
        </constructor-arg>
        <!-- used to test account states
             see businessCategory in src/test/config/ldap.ldif
        <property name="authenticationResponseHandlers">
          <bean class="idp.MockAuthenticationResponseHandler">
            <constructor-arg>
              <array>
              <bean class="org.ldaptive.auth.AccountState">
                <constructor-arg>
                  <bean class="org.ldaptive.auth.AccountState.DefaultWarning">
                    <constructor-arg index="0">
                      <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
                        <property name="staticMethod"><value>java.util.Calendar.getInstance</value></property>
                      </bean>
                    </constructor-arg>
                    <constructor-arg index="1"><value>10</value></constructor-arg>
                  </bean>
                </constructor-arg>
              </bean>
              <bean class="org.ldaptive.auth.ext.PasswordPolicyAccountState">
                <constructor-arg index="0">
                  <value type="org.ldaptive.control.PasswordPolicyControl.Error">PASSWORD_EXPIRED</value>
                </constructor-arg>
              </bean>
              </array>
            </constructor-arg>
          </bean>
        </property>
        -->
    </bean>

    <bean name="connectionFactory" class="org.ldaptive.DefaultConnectionFactory" lazy-init="true">
        <constructor-arg>
            <bean class="org.ldaptive.ConnectionConfig"
                p:ldapUrl-ref="shibboleth.authn.LDAP.ldapUrl" />
        </constructor-arg>
    </bean>
    
</beans>
