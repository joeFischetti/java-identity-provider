<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd"
      parent="Authentication.Abstract">

    <!--
    This is the Authentication subflow. It handles retrieval of an existing session,
    set up and eventual selection of an subflow or active AuthenticationResult, and
    finalization of the processing such as updating a session, before returning control
    to the calling flow.
    -->
    
    <action-state id="AuthenticationSetup">
        <evaluate expression="PopulateAuthenticationContext" />
        <evaluate expression="PopulateSessionContext" />
        <evaluate expression="ExtractActiveAuthenticationResults" />
        <evaluate expression="FilterFlowsByForcedAuthn" />
        <evaluate expression="FilterFlowsByPassivity" />
        <evaluate expression="'proceed'" />

        <transition on="proceed" to="SelectAuthenticationFlow" />
    </action-state>
    
    <!--
    The Select action is the "dispatching" step. Proceed here routes around
    calling a new subflow, and goes directly to the Finalize step. Anything
    starting with "AuthenticationFlow/" is a flow descriptor that we send
    control to to attempt a login.
    -->
    <action-state id="SelectAuthenticationFlow">
        <evaluate expression="SelectAuthenticationFlow" />
        <evaluate expression="'proceed'" />
        
        <!-- proceed indicates SSO (reuse of active result) -->
        <transition on="proceed" to="FinalizeAuthentication" />

        <!-- Call a subflow with the same ID as the event. -->
        <transition on="#{currentEvent.id.startsWith('AuthenticationFlow/')}" to="CallAuthenticationFlow" />
    </action-state>

    <!--
    This invokes an authentication flow to attempt a login. Anything but proceed
    is an error, otherwise control passes to the wrap-up actions, except for a
    ReselectFlow signal to loop back up and try another.
    -->
    <subflow-state id="CallAuthenticationFlow" subflow="#{currentEvent.id}">
        <input name="calledAsSubflow" value="true" />
        <transition on="proceed" to="CallSubjectCanonicalization" />
        <transition on="ReselectFlow" to="SelectAuthenticationFlow" />
    </subflow-state>

    <!-- This runs a canonicalization step on the result of the authentication. -->
    <subflow-state id="CallSubjectCanonicalization" subflow="c14n/authn">
        <input name="calledAsSubflow" value="true" />
        <transition on="proceed" to="InvalidateSessionOnIdentitySwitch" />
    </subflow-state>

    <!-- Handles an identity switch by dumping the old session. -->
    <action-state id="InvalidateSessionOnIdentitySwitch">
        <evaluate expression="InvalidateSessionOnIdentitySwitch" />
        <evaluate expression="'proceed'" />
        
        <transition on="proceed" to="FinalizeAuthentication" />
        <!-- Ignore any session layer errors at this stage. -->
        <transition on="InputOutputError" to="FinalizeAuthentication" />
    </action-state>
    
    <!--
    Wraps up the subflow or result reuse by producing a SubjectContext. If a mismatch
    exists between an existing SubjectContext and the result here, an error occurs.
    -->
    <action-state id="FinalizeAuthentication">
        <evaluate expression="FinalizeAuthentication" />
        <evaluate expression="'proceed'" />
        
        <transition on="proceed" to="UpdateSessionWithAuthenticationResult" />
    </action-state>
    
    <!-- Finally, create/update the client session. -->
    <action-state id="UpdateSessionWithAuthenticationResult">
        <evaluate expression="UpdateSessionWithAuthenticationResult" />
        <evaluate expression="'proceed'" />
        
        <transition on="proceed" to="proceed" />
        
        <!-- Ignore any session layer errors at this stage. -->
        <transition on="InputOutputError" to="proceed" />
    </action-state>

    <bean-import resource="authn-beans.xml" />

</flow>
